name: Run unit tests

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ '*' ]

  repository_dispatch:
    types: [test]

permissions:
  contents: read
  pull-requests: write

jobs:
  run-unit-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'adopt'
        java-version: '17'

    - name: Build
      id: build
      run: |
        ./gradlew check -S --no-daemon 2>&1 | tee build-output.txt
        echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
      env:
        JAVA_OPTS: -Xmx8g -XX:MetaspaceSize=1g -Dfile.encoding=UTF-8
        JVM_OPTS:  -Xmx8g -XX:MetaspaceSize=1g -Dfile.encoding=UTF-8

    - name: Generate coverage report
      if: success() && github.event_name == 'pull_request'
      run: |
        ./gradlew koverLog --no-daemon 2>&1 | tee coverage-output.txt

    - name: Comment coverage on PR
      if: success() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let output = '';
          try {
            output = fs.readFileSync('coverage-output.txt', 'utf8');
          } catch (e) {
            output = '';
          }

          // Parse coverage lines: "> Task :module:koverPrintCoverage" followed by "application line coverage: XX%"
          const lines = output.split('\n');
          const rows = [];
          for (let i = 0; i < lines.length; i++) {
            const taskMatch = lines[i].match(/> Task :(.+):koverPrintCoverage/);
            if (taskMatch && i + 1 < lines.length) {
              const covMatch = lines[i + 1].match(/application line coverage: ([\d.]+)%/);
              if (covMatch) {
                const module = taskMatch[1];
                const pct = parseFloat(covMatch[1]);
                const icon = pct >= 98 ? ':white_check_mark:' : pct >= 50 ? ':large_orange_diamond:' : ':red_circle:';
                rows.push(`| ${module} | ${icon} ${pct.toFixed(1)}% |`);
              }
            }
          }

          if (rows.length === 0) return;

          const body = [
            '## :bar_chart: Test Coverage',
            '',
            '| Module | Line Coverage |',
            '|--------|-------------|',
            ...rows,
            '',
            `[View full logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
          ].join('\n');

          // Update existing coverage comment or create new one
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });
          const existing = comments.find(c => c.body.includes(':bar_chart: Test Coverage'));
          if (existing) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existing.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }

    - name: Comment build failure on PR
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let output = '';
          try {
            output = fs.readFileSync('build-output.txt', 'utf8');
          } catch (e) {
            output = 'Build output not available.';
          }

          // Truncate to last 200 lines to stay within comment size limits
          const lines = output.split('\n');
          const tail = lines.slice(-200).join('\n');
          const truncated = lines.length > 200
            ? `\n> Showing last 200 of ${lines.length} lines\n\n`
            : '';

          const body = `## :x: Build Failed\n\n${truncated}\`\`\`\n${tail}\n\`\`\`\n\n[View full logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: body
          });
